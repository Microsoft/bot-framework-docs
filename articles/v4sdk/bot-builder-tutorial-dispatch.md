---
title: Use the Dispatch tool for LUIS and QnA Maker | Microsoft Docs
description: Learn how to use LUIS and QnA maker in your bot.
keywords: Luis, QnA, Dispatch tool, multiple services
author: DeniseMak
ms.author: v-demak
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 04/25/2018
monikerRange: 'azure-bot-service-4.0'
---

## Integrate multiple LUIS apps and QnA services with the Dispatch tool

This tutorial demonstrates how to use a LUIS model generated by the Dispatch tool, to integrate your bot with multiple Language Understanding (LUIS) apps and QnAMaker services. 

Imagine you've developed the following services, and you want to create a bot that integrates with all of them.

| Service type | Name | Description |
|------|------|------|
| LUIS app | HomeAutomation | Recognizes the HomeAutomation.TurnOn, HomeAutomation.TurnOff, and HomeAutomation.None intents.|
| LUIS app | Weather | Recognizes the Weather.GetForecast and Weather.GetCondition intents.|
| QnAMaker service | FAQ  | Provides answers to questions about a home automation lighting system |

Let's first create the apps and services, then integrate them together.

> [!NOTE]
> All three apps need to be created within the same Azure location for Dispatch to access them successfully. Our example Dispatch code below uses the example location West US.

## Create the LUIS apps

The fastest way to create the HomeAutomation and Weather LUIS apps is to download the [homeautomation.json][HomeAutomationJSON] and [weather.json][WeatherJSON] files. Then go to the [LUIS website](https://www.luis.ai/home) and sign in. Click on **My Apps** > **Import new app** and choose the homeautomation.json file. Name the new app `homeautomation`. Click on **My Apps** > **Import new app** and choose the weather.json file. Name this other new app `weather`.

## Create the QnA Maker service

Go to the [QnA Maker website](https://qnamaker.ai) and sign in. Select **Create a knowledge base** and create a new knowledge base named "FAQ". Click the **Select file** button and upload the [sample TSV file][FAQ_TSV]. Click **Create**, and once the service is created, click **Publish**.

## Use the Dispatch tool to create the dispatcher LUIS app

Next, let's create a LUIS app to combine each of the services we created.

Install the [Dispatch tool][DispatchTool] by running this command at a Node.js command prompt.

```
npm install -g botdispatch
```

Run the following command to initialize the Dispatch tool of the name `CombineWeatherAndLights`. Substitute your [LUIS authoring key](https://docs.microsoft.com/en-us/azure/cognitive-services/LUIS/luis-concept-keys) for `"YOUR-LUIS-AUTHORING-KEY"`.

```
dispatch init -name CombineWeatherAndLights -luisAuthoringKey "YOUR-LUIS-AUTHORING-KEY" -luisAuthoringRegion westus
```

For each of the LUIS apps that you created, get the LUIS app ID. Those can be found for each app under **My Apps** on the [LUIS site](https://www.luis.ai/home); click on the app name, and then click on **Settings** to see the Application ID. 

Then run the `dispatch add` command for each of the LUIS apps and the QnA Maker service you created:

```
dispatch add -type luis -id "HOMEAUTOMATION-APP-ID" -name homeautomation -version 0.1 -key "YOUR-LUIS-AUTHORING-KEY"
dispatch add -type luis -id "WEATHER-APP-ID" -name weather -version 0.1 -key "YOUR-LUIS-AUTHORING-KEY"
dispatch add -type qna -id "QNA-KB-ID" -name faq -key "YOUR-QNA-SUBSCRIPTION-KEY"
```

Run `dispatch create`:

```
dispatch create
```

This creates the dispatcher LUIS app named **CombineWeatherAndLights**. You can see the new app in [https://www.luis.ai/home](https://www.luis.ai/home). 

![The dispatcher app in LUIS.ai](media/tutorial-dispatch/dispatch-app-in-luis.png)

Click on the new app. Under **Intents** you can see it has the `l_homeautomation`, `l_weather`, and `q_faq` intents.

![The dispatcher intents in LUIS.ai](media/tutorial-dispatch/dispatch-intents-in-luis.png)

Click the **Train** button to train the LUIS app, and use the **PUBLISH** tab to [publish](https://docs.microsoft.com/en-us/azure/cognitive-services/LUIS/publishapp) it. Click on **Settings** to copy the ID of the new app to use in your bot.

## Create the bot

Now you can hook up the dispatcher app's intents to logic in your bot, which routes messages to the original LUIS apps and QnAMaker service.

You can use the sample included with the Bot Builder SDK as a starting point.

# [C#](#tab/csaddref)

Start with the code in the [LUIS Dispatch sample][DispatchBotCS]. In Visual Studio,
[update Nuget packages](https://docs.microsoft.com/en-us/nuget/tools/package-manager-ui#updating-a-package) to the latest prerelease versions of the following:

* `Microsoft.Bot.Builder.Integration.AspNet.Core`
* `Microsoft.Bot.Builder.Ai.QnA` (required for QnA Maker)
* `Microsoft.Bot.Builder.Ai.Luis` (required for LUIS)

# [JavaScript](#tab/jsaddref)

Download the [LUIS Dispatch sample][DispatchBotJs].  Install the required packages, including the `botbuilder-ai` package for LUIS and QnA Maker, using npm:

* `npm install --save botbuilder@preview`
* `npm install --save botbuilder-ai@preview`

---


Set up the sample to use the dispatcher app.

# [C#](#tab/csbotconfig)

In **appsettings.json** in the [LUIS Dispatch sample][DispatchBotCS], edit the following fields.

| Name | Description |
|------|------|
| `Luis-SubscriptionKey` |  Your LUIS subscription key. This can be an endpoint key or an authoring key, described [here](https://docs.microsoft.com/en-us/azure/cognitive-services/luis/luis-concept-keys). | 
| `Luis-ModelId-Dispatcher` | App ID for the LUIS app that the Dispatch tool generates. | 
| `Luis-ModelId-HomeAutomation` | App ID of the app you created from homeautomation.json  | 
| `Luis-ModelId-Weather` | App ID of the app you created from weather.json | 
| `QnAMaker-Endpoint-Url` | This should be set to https://westus.api.cognitive.microsoft.com/qnamaker/v2.0 for Preview QnA Maker services. <br/>Set this to https://YOUR-QNA-SERVICE-NAME.azurewebsites.net/qnamaker for new (GA) QnA Maker services.|
| `QnAMaker-SubscriptionKey` | Your QnA Maker subscription key. | 
| `QnAMaker-KnowledgeBaseId` | The ID of the knowledge base you create at the [QnAMaker portal](https://qnamaker.ai).| 



In **Startup.cs**, take a look at the `ConfigureServices` method. It contains code to initialize `LuisRecognizerMiddleware` using the app ID of the LUIS app you just generated.

```csharp
// This method gets called by the runtime. Use this method to add services to the container.
public void ConfigureServices(IServiceCollection services)
{
    services.AddSingleton(this.Configuration);
    services.AddBot<LuisDispatchBot>(options =>
    {
        options.CredentialProvider = new ConfigurationCredentialProvider(Configuration);

        var (luisModelId, luisSubscriptionKey, luisUri) = GetLuisConfiguration(this.Configuration, "Dispatcher");

        var luisModel = new LuisModel(luisModelId, luisSubscriptionKey, luisUri);

        // If you want to get all the intents and scores that LUIS recognized, set Verbose = true in luisOptions
        var luisOptions = new LuisRequest { Verbose = true };

        var middleware = options.Middleware;
        middleware.Add(new LuisRecognizerMiddleware(luisModel, luisOptions: luisOptions));
    });
}
```
The `GetLuisConfiguration` and `GetQnAMakerConfiguration` methods get your LUIS and QnA configuration from appsettings.json.
```csharp
public static (string modelId, string subscriptionId, Uri uri) GetLuisConfiguration(IConfiguration configuration, string serviceName)
{
    var modelId = configuration.GetSection($"Luis-ModelId-{serviceName}")?.Value;
    var subscriptionId = configuration.GetSection("Luis-SubscriptionKey")?.Value;
    var uri = new Uri(configuration.GetSection("Luis-Url")?.Value);
    return (modelId, subscriptionId, uri);
}

public static (string knowledgeBaseId, string subscriptionKey, string uri) GetQnAMakerConfiguration(IConfiguration configuration)
{
    var knowledgeBaseId = configuration.GetSection("QnAMaker-KnowledgeBaseId")?.Value;
    var subscriptionKey = configuration.GetSection("QnAMaker-SubscriptionKey")?.Value;
    var uri = configuration.GetSection("QnAMaker-Endpoint-Url")?.Value;
    return (knowledgeBaseId, subscriptionKey, uri);
}
```

### Dispatch the message

Take a look at **LuisDispatchBot.cs**, where the bot dispatches the message to the LUIS app or QnA Maker for a subcomponent. 

In `DispatchToTopIntent`, if your dispatcher app detects the `l_homeautomation` or `l_weather` intent, it calls a `DispatchToTopIntent` method that creates a `LuisRecognizer` to call the original `homeautomation` and `weather` apps. If the bot detects the `q_faq` intent, or the `none` intent that is used as a fallback case, it calls a method that queries QnAMaker.

> [!NOTE] 
> If the intent names `l_homeautomation`, `l_weather` or `q_faq` don't match the LUIS app you created using Dispatch, edit them to match the lower case version of the intent names you see in the [LUIS portal](https://www.luis.ai).

```csharp
private async Task DispatchToTopIntent(ITurnContext context, (string intent, double score)? topIntent)
{
    switch (topIntent.Value.intent.ToLowerInvariant())
    {
        case "l_homeautomation":
            await DispatchToLuisModel(context, this.luisModelHomeAutomation, "home automation");
            break;
        case "l_weather":
            await DispatchToLuisModel(context, this.luisModelWeather, "weather");
            break;
        case "none":
        // You can provide logic here to handle the known None intent (none of the above).
        // In this example we fall through to the QnA intent.
        case "q_faq":
            await DispatchToQnAMaker(context, this.qnaEndpoint, "FAQ");
            break;
        default:
            // The intent didn't match any case, so just display the recognition results.
            await context.SendActivity($"Dispatch intent: {topIntent.Value.intent} ({topIntent.Value.score}).");

            break;
    }
}
```

The `DispatchToQnAMaker` method sends the user's message to the QnA Maker service. Make sure you have published that service in the [QnA Maker portal](https://qnamaker.ai) before you run the bot.

```csharp
private static async Task DispatchToQnAMaker(ITurnContext context, QnAMakerEndpoint qnaOptions, string appName)
{
    QnAMaker qnaMaker = new QnAMaker(qnaOptions);
    if (!string.IsNullOrEmpty(context.Activity.Text))
    {
        var results = await qnaMaker.GetAnswers(context.Activity.Text.Trim()).ConfigureAwait(false);
        if (results.Any())
        {
            await context.SendActivity(results.First().Answer);
        }
        else
        {
            await context.SendActivity($"Couldn't find an answer in the {appName}.");
        }
    }
}
```

The `DispatchToLuisModel` method sends the user's message to the original `homeautomation` and `weather` LUIS apps. Make sure you have published those LUIS apps in the [LUIS portal](https://www.luis.ai) before you run the bot.

```csharp
private static async Task DispatchToLuisModel(ITurnContext context, LuisModel luisModel, string appName)
{
    await context.SendActivity($"Sending your request to the {appName} system ...");
    var (intents, entities) = await RecognizeAsync(luisModel, context.Activity.Text);

    await context.SendActivity($"Intents detected by the {appName} app:\n\n{string.Join("\n\n", intents)}");

    if (entities.Count() > 0)
    {
        await context.SendActivity($"The following entities were found in the message:\n\n{string.Join("\n\n", entities)}");
    }
    
    // Here, you can add code for calling the hypothetical home automation or weather service, 
    // passing in the appName and any intent or entity information that you need 
}
```

The `RecognizeAsync` method calls a `LuisRecognizer` to get results from a LUIS app.

```cs
private static async Task<(IEnumerable<string> intents, IEnumerable<string> entities)> RecognizeAsync(LuisModel luisModel, string text)
{
    var luisRecognizer = new LuisRecognizer(luisModel);
    var recognizerResult = await luisRecognizer.Recognize(text, System.Threading.CancellationToken.None);

    // list the intents
    var intents = new List<string>();
    foreach (var intent in recognizerResult.Intents)
    {
        intents.Add($"'{intent.Key}', score {intent.Value}");
    }

    // list the entities
    var entities = new List<string>();
    foreach (var entity in recognizerResult.Entities)
    {
        if (!entity.Key.ToString().Equals("$instance"))
        {
            entities.Add($"{entity.Key}: {entity.Value.First}");
        }
    }

    return (intents, entities);
}
```

# [JavaScript](#tab/jsbotconfig)

Start with the code in the [Dispatch bot sample][DispatchBotJs]. Open **app.js** and optionally replace the `appId` fields with the IDs of the LUIS apps you created. If you leave the `appId` fields as they originally are, you'll be using public LUIS apps created for demonstration purposes.

```javascript
// Create LuisRecognizers and QnAMaker
// The LUIS applications are public, meaning you can use your own subscription key to test the applications.
// For QnAMaker, users are required to create their own knowledge base.
// The exported LUIS applications and QnAMaker knowledge base can be found with the sample bot.

// The corresponding LUIS application JSON is `dispatchSample.json`
const dispatcher = new LuisRecognizer({
    appId: '0b18ab4f-5c3d-4724-8b0b-191015b48ea9',
    subscriptionKey: process.env.LUIS_SUBSCRIPTION_KEY,
    serviceEndpoint: 'https://westus.api.cognitive.microsoft.com/',
    verbose: true
});

// The corresponding LUIS application JSON is `homeautomation.json`
const homeAutomation = new LuisRecognizer({
    appId: 'c6d161a5-e3e5-4982-8726-3ecec9b4ed8d',
    subscriptionKey: process.env.LUIS_SUBSCRIPTION_KEY,
    serviceEndpoint: 'https://westus.api.cognitive.microsoft.com/',
    verbose: true
});

// The corresponding LUIS application JSON is `weather.json`
const weather = new LuisRecognizer({
    appId: '9d0c9e9d-ce04-4257-a08a-a612955f2fb5',
    subscriptionKey: process.env.LUIS_SUBSCRIPTION_KEY,
    serviceEndpoint: 'https://westus.api.cognitive.microsoft.com/',
    verbose: true
});
```

In the following code, replace the `endpointKey` and `knowledgeBaseID` with your key and knowledge base ID from QnAMaker. The `host` should be set to `https://westus.api.cognitive.microsoft.com/qnamaker/v2.0` for Preview QnA Maker services, and `https://YOUR-QNA-SERVICE-NAME.azurewebsites.net/qnamaker` for new (GA) QnA Maker services.

```javascript
const faq = new QnAMaker(
    {
        knowledgeBaseId: '',
        endpointKey: '',
        host: ''
    },
    {
        answerBeforeNext: true
    }
);

```

The rest of the code in **app.js** handles the `l_homeautomation`, `l_weather`, and `None` intents by launching appropriate dialogs. In the case of the `q_faq` intent, it replies with the answer from the QnAMaker service.

> [!NOTE] 
> If the intent names `l_homeautomation`, `l_weather` or `q_faq` don't match the LUIS app you created using Dispatch, edit them to match the intent names you see in the [LUIS portal](https://www.luis.ai).

```javascript
// create conversation state
const conversationState = new ConversationState(new MemoryStorage());
adapter.use(conversationState);

// register some dialogs for usage with the LUIS apps that are being dispatched to
const dialogs = new DialogSet();

function findEntities(entityName, entityResults) {
    let entities = []
    if (entityName in entityResults) {
        entityResults[entityName].forEach((entity, idx) => {
            entities.push(entity);
        });
    }
    return entities.length > 0 ? entities : undefined;
}

dialogs.add('HomeAutomation_TurnOff', [
    async (dialogContext, args) => {
        const devices = findEntities('HomeAutomation_Device', args.entities);
        const operations = findEntities('HomeAutomation_Operation', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.homeAutomationTurnOff = state.homeAutomationTurnOff ? state.homeAutomationTurnOff + 1 : 1;
        await dialogContext.context.sendActivity(`${state.homeAutomationTurnOff}: You reached the "HomeAutomation.TurnOff" dialog.`);
        if (devices) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Device" entities:\n${devices.join(', ')}`);
        }
        if (operations) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Operation" entities:\n${operations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('HomeAutomation_TurnOn', [
    async (dialogContext, args) => {
        const devices = findEntities('HomeAutomation_Device', args.entities);
        const operations = findEntities('HomeAutomation_Operation', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.homeAutomationTurnOn = state.homeAutomationTurnOn ? state.homeAutomationTurnOn + 1 : 1;
        await dialogContext.context.sendActivity(`${state.homeAutomationTurnOn}: You reached the "HomeAutomation.TurnOn" dialog.`);
        if (devices) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Device" entities:\n${devices.join(', ')}`);
        }
        if (operations) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Operation" entities:\n${operations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('Weather_GetForecast', [
    async (dialogContext, args) => {
        const locations = findEntities('Weather_Location', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.weatherGetForecast = state.weatherGetForecast ? state.weatherGetForecast + 1 : 1;
        await dialogContext.context.sendActivity(`${state.weatherGetForecast}: You reached the "Weather.GetForecast" dialog.`);
        if (locations) {
            await dialogContext.context.sendActivity(`Found these "Weather_Location" entities:\n${locations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('Weather_GetCondition', [
    async (dialogContext, args) => {
        const locations = findEntities('Weather_Location', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.weatherGetCondition = state.weatherGetCondition ? state.weatherGetCondition + 1 : 1;
        await dialogContext.context.sendActivity(`${state.weatherGetCondition}: You reached the "Weather.GetCondition" dialog.`);
        if (locations) {
            await dialogContext.context.sendActivity(`Found these "Weather_Location" entities:\n${locations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('None', [
    async (dialogContext) => {
        const state = conversationState.get(dialogContext.context);
        state.noneIntent = state.noneIntent ? state.noneIntent + 1 : 1;
        await dialogContext.context.sendActivity(`${state.noneIntent}: You reached the "None" dialog.`);
        await dialogContext.end();
    }
]);

adapter.use(dispatcher);

// Listen for incoming Activities
server.post('/api/messages', (req, res) => {
    adapter.processActivity(req, res, async (context) => {
        if (context.activity.type === 'message') {
            const state = conversationState.get(context);
            const dc = dialogs.createContext(context, state);

            // Retrieve the LUIS results from our dispatcher LUIS application
            const luisResults = dispatcher.get(context);

            // Extract the top intent from LUIS and use it to select which LUIS application to dispatch to
            const topIntent = LuisRecognizer.topIntent(luisResults);

            const isMessage = context.activity.type === 'message';
            if (isMessage) {
                switch (topIntent) {
                    case 'l_homeautomation':
                        const homeAutoResults = await homeAutomation.recognize(context);
                        const topHomeAutoIntent = LuisRecognizer.topIntent(homeAutoResults);
                        await dc.begin(topHomeAutoIntent, homeAutoResults);
                        break;
                    case 'l_weather':
                        const weatherResults = await weather.recognize(context);
                        const topWeatherIntent = LuisRecognizer.topIntent(weatherResults);
                        await dc.begin(topWeatherIntent, weatherResults);
                        break;
                    case 'q_faq':
                        await faq.answer(context);
                        break;
                    default:
                        await dc.begin('None');
                }
            }

            if (!context.responded) {
                await dc.continue();
                if (!context.responded && isMessage) {
                    await dc.context.sendActivity(`Hi! I'm the LUIS dispatch bot. Say something and LUIS will decide how the message should be routed.`);
                }
            }
        }
    });
});

```

---
## Run the bot

Test out the bot using the [Bot Framework Emulator](../bot-service-debug-emulator.md). Send it messages like "turn on the lights" to dispatch the message to the home automation LUIS app, and send it messages like "get the weather in Seattle" to dispatch to the weather LUIS app.

> [!NOTE] 
> Before you run the bot, make sure you have published all the LUIS apps that you created in the [LUIS portal](https://www.luis.ai), and check that you've published the QnA Maker service in the [QnA Maker portal](https://qnamaker.ai).

![Send messages to the dispatch bot](media/tutorial-dispatch/run-dispatch-bot.png)

## Evaluate the dispatcher's performance

Sometimes there are user messages that are provided as examples in both the LUIS apps and the QnA maker services, and the combined LUIS app that Dispatch generates won't perform well for those inputs. Check your app's performance using the `eval` option. 

```
dispatch eval
```

Running `dispatch eval` generates a **Summary.html** file that provides statistics on the performance of the new language model.

> [!TIP] 
> You can actually run `dispatch eval` on any LUIS app, not just LUIS apps created by the dispatch tool.

### Edit intents for duplicates and overlaps

Review example utterances that are flagged as duplicates in **Summary.html**, and remove similar or overlapping examples. For example, let's say that in the `homeautomation` LUIS app for homeautomation, requests like "turn my lights on" map to a "TurnOnLights" intent, but requests like "Why won't my lights turn on?" map to a "None" intent so that they can be passed on to QnA maker. When you combine the LUIS app and the QnA maker service using dispatch, you need to do one of the following: 

* Remove the "None" intent from the original `homeautomation` LUIS app, and add the utterances in that intent to the "None" intent in the dispatcher app.
* If you don't remove the "None" intent from the original LUIS app, you need to add logic in your bot to pass those messages that match that intent on to the QnA maker service.

> [!TIP] 
> Review [Best practices for Language Understanding](./bot-builder-concept-luis.md#best-practices-for-language-understanding) for tips on improving your language model's performance.

## Additional resources

* [Using LUIS for conversation flow][luis-v4-how-to]

[luis-v4-how-to]: bot-builder-howto-v4-luis.md
<!-- links -->

[HomeAutomationJSON]: https://aka.ms/dispatch-luis1
[WeatherJSON]: https://aka.ms/dispatch-luis2
[DispatchJSON]: https://aka.ms/dispatch-luis
[FAQ_TSV]: https://aka.ms/dispatch-qna-tsv

[DispatchTool]: https://github.com/Microsoft/botbuilder-tools/tree/master/Dispatch
[DispatchBotCS]: https://aka.ms/dispatch-sample-cs
[DispatchBotJs]: https://aka.ms/dispatch-sample-js



